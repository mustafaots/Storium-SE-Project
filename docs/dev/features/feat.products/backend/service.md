# Products Service

## Purpose
Contains business logic for product operations. Handles data validation, transformation, pagination, and calls the database models.

## File Location
`backend/src/services/products.service.js`

## Key Methods

### getAllPaginated(page, limit, search)
Fetches products with pagination and optional search filtering.

**Input Data Types:**
```javascript
page: number              // Page number (1-based)
limit: number             // Items per page
search: string            // Search query string (empty string if no search)
```

**Internal Processing:**
```javascript
// Validation
validatedPage: number     // Math.max(1, parseInt(page))
validatedLimit: number    // Math.min(Math.max(1, limit), MAX_LIMIT)
offset: number            // (validatedPage - 1) * validatedLimit

// Search conditions
searchParams: any[]       // Parameters for SQL parameterized query
whereClause: string       // SQL WHERE clause or empty string

// Query building
query: string             // Multi-line SQL SELECT with JOINs
params: any[]             // Array of [limit, offset] for LIMIT/OFFSET
```

**Output Data Types:**
```javascript
{
  products: Product[],     // Array of product objects
  pagination: {
    page: number,
    limit: number,
    total: number,          // Total matching products
    pages: number           // Math.ceil(total / limit)
  }
}

// Product object from database
Product = {
  product_id: number,
  name: string,
  category: string,
  description: string | null,
  unit: string,
  min_stock_level: number,
  max_stock_level: number,
  rate: number,
  rate_unit: string,
  image_mime_type: string | null,
  image_data: string | null,        // Base64 encoded
  total_stock: number,              // Calculated from stocks table
  source_id: number | null,
  supplier: string | null           // From sources table
}
```

---

### getById(id)
Retrieves a single product with all details.

**Input Data Types:**
```javascript
id: number  // Product ID
```

**Output Data Types:**
```javascript
Product | null  // Product object or null if not found
```

---

### createProduct(productData)
Creates a new product record in the database.

**Input Data Types:**
```javascript
productData = {
  name: string,
  category: string,
  description: string | null,
  unit: string,
  rate: number,           // Decimal(10,2)
  rate_unit: string,
  min_stock_level: number,
  max_stock_level: number,
  image: {
    buffer: Buffer,       // File bytes from multer
    mimetype: string,     // e.g., "image/jpeg"
    originalname: string
  } | null
}
```

**Database Operations:**
```javascript
// Image processing
imageBase64: string       // Base64 encoded image

// INSERT query parameters
INSERT_params = [
  name: string,
  category: string,
  description: string | null,
  unit: string,
  rate: number,
  rate_unit: string,
  min_stock_level: number,
  max_stock_level: number,
  imageBase64: string | null,
  imageMimetype: string | null
]
```

**Output Data Types:**
```javascript
{
  product_id: number,      // Generated by database
  name: string,
  category: string,
  unit: string,
  rate: number,
  rate_unit: string,
  created_at: Date
}
```

---

### updateProduct(id, productData)
Updates an existing product.

**Input Data Types:**
```javascript
id: number

productData = {
  name: string | undefined,
  category: string | undefined,
  description: string | null | undefined,
  unit: string | undefined,
  rate: number | undefined,
  rate_unit: string | undefined,
  min_stock_level: number | undefined,
  max_stock_level: number | undefined,
  image: {
    buffer: Buffer,
    mimetype: string,
    originalname: string
  } | null | undefined
}
```

**Database Operations:**
```javascript
// Only update provided fields
updateFields: string[]    // SQL SET clauses for provided fields
updateParams: any[]       // Values for provided fields

// Query: UPDATE products SET field1=?, field2=? WHERE product_id=?
```

**Output Data Types:**
```javascript
Product  // Updated product object
```

---

### deleteProduct(id)
Deletes a product (cascades to stocks, transactions).

**Input Data Types:**
```javascript
id: number  // Product ID
```

**Database Effects:**
```javascript
// DELETE FROM products WHERE product_id = ?
// Cascades delete to:
// - stocks (product_id FK)
// - transactions (product_id FK)
// - product_sources (product_id FK)
```

**Output Data Types:**
```javascript
{
  product_id: number,
  affectedRows: number,    // Number of deleted records
  success: boolean
}
```

---

### searchProducts(query, limit)
Searches products by name, category, or description.

**Input Data Types:**
```javascript
query: string             // Search term
limit: number             // Max results to return
```

**Output Data Types:**
```javascript
Product[]                 // Matching products
```

---

## Data Validation

### Product Validation Rules

```javascript
{
  name: {
    type: string,
    required: true,
    minLength: 1,
    maxLength: 255
  },
  category: {
    type: string,
    required: true,
    maxLength: 100
  },
  unit: {
    type: string,
    required: true,
    examples: ["kg", "box", "unit", "liter"]
  },
  rate: {
    type: number,
    required: true,
    minimum: 0,
    precision: "decimal(10,2)"
  },
  rate_unit: {
    type: string,
    required: true,
    examples: ["USD", "EUR", "GBP"]
  },
  min_stock_level: {
    type: number,
    required: false,
    minimum: 0
  },
  max_stock_level: {
    type: number,
    required: false,
    minimum: 0
  },
  image: {
    type: Buffer | null,
    required: false,
    maxSize: "5MB",
    allowedTypes: ["image/jpeg", "image/png", "image/gif", "image/webp"]
  }
}
```

---

## SQL Queries Generated

### GET All Products
```sql
SELECT 
  p.product_id, p.name, p.category, p.description, p.unit,
  p.min_stock_level, p.max_stock_level, p.rate, p.rate_unit,
  p.image_mime_type, TO_BASE64(p.image_data) AS image_data,
  COALESCE(st.total_stock, 0) AS total_stock,
  ps.source_id, src.source_name AS supplier
FROM products p
LEFT JOIN (
  SELECT product_id, SUM(quantity) as total_stock 
  FROM stocks 
  GROUP BY product_id
) st ON p.product_id = st.product_id
LEFT JOIN product_sources ps ON p.product_id = ps.product_id
LEFT JOIN sources src ON ps.source_id = src.source_id
WHERE [search conditions]
ORDER BY p.created_at DESC
LIMIT ? OFFSET ?
```

### CREATE Product
```sql
INSERT INTO products 
(name, category, description, unit, rate, rate_unit, min_stock_level, max_stock_level, image_data, image_mime_type, created_at)
VALUES (?, ?, ?, ?, ?, ?, ?, ?, FROM_BASE64(?), ?, NOW())
```

### UPDATE Product
```sql
UPDATE products 
SET name=?, category=?, description=?, unit=?, rate=?, rate_unit=?, min_stock_level=?, max_stock_level=?
WHERE product_id=?
```

---

## Dependencies
- `config/database.js` - Database connection pool
- `models/products.model.js` - Database queries
- `utils/constants.js` - Constants and config
- `utils/database.js` - Query builders and helpers
